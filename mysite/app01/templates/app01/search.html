{% extends 'app01/base.html' %}

{% block title %}搜索 - 新闻推荐系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 搜索框 -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form id="search-form" method="get" action="{% url 'search' %}">
                    <div class="input-group input-group-lg">
                        <input type="text" name="q" class="form-control" 
                               placeholder="搜索新闻、标签..." 
                               value="{{ query }}"
                               id="search-input">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 搜索建议 -->
        <div class="mb-4">
            <h6>热门搜索：</h6>
            <div>
                <span class="badge bg-light text-dark border me-2 mb-2" style="cursor: pointer;" 
                      onclick="setSearchQuery('计算机学院')">计算机学院</span>
                <span class="badge bg-light text-dark border me-2 mb-2" style="cursor: pointer;" 
                      onclick="setSearchQuery('考试信息')">考试信息</span>
                <span class="badge bg-light text-dark border me-2 mb-2" style="cursor: pointer;" 
                      onclick="setSearchQuery('科学研究')">科学研究</span>
                <span class="badge bg-light text-dark border me-2 mb-2" style="cursor: pointer;" 
                      onclick="setSearchQuery('课程安排')">课程安排</span>
            </div>
        </div>

        <!-- 搜索结果 -->
        <div id="search-results">
            {% if query %}
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">搜索中...</span>
                    </div>
                    <p class="mt-3">正在搜索 "{{ query }}"...</p>
                </div>
            {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <p>请输入关键词搜索相关新闻</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 页面加载时如果有搜索词，执行搜索
document.addEventListener('DOMContentLoaded', function() {
    const query = "{{ query }}";
    if (query) {
        performSearch(query);
    }
});

// 执行搜索
function performSearch(query) {
    fetch(`/news/api/search-news/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            displaySearchResults(data.results, query);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('search-results').innerHTML = 
                '<div class="alert alert-danger">搜索失败，请稍后重试</div>';
        });
}

// 显示搜索结果
function displaySearchResults(results, query) {
    const container = document.getElementById('search-results');
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                没有找到关于 "<strong>${query}</strong>" 的搜索结果
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>找到 ${results.length} 条相关结果</h5>
            <small class="text-muted">搜索词: ${query}</small>
        </div>
    `;
    
    results.forEach(result => {
        html += `
        <div class="news-card p-3 mb-3">
            <h6><a href="${result.url || '#'}" class="text-decoration-none">${result.summary || '无标题'}</a></h6>
            <p class="text-muted small mb-2">${result.summary || '无摘要'}</p>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted me-3">
                        <i class="fas fa-clock me-1"></i>${result.publish_date || '未知时间'}
                    </small>
                    ${result.tag_names ? result.tag_names.split(', ').map(tag => 
                        `<span class="badge bg-light text-dark border me-1">${tag}</span>`
                    ).join('') : ''}
                </div>
                <a href="${result.url || '#'}" class="btn btn-outline-primary btn-sm" target="_blank">
                    查看详情
                </a>
            </div>
        </div>
        `;
    });
    
    container.innerHTML = html;
}

// 设置搜索词
function setSearchQuery(query) {
    document.getElementById('search-input').value = query;
    document.getElementById('search-form').submit();
}

// 实时搜索（可选功能）
document.getElementById('search-input').addEventListener('input', function(e) {
    // 可以在这里添加实时搜索功能
    // 为了性能考虑，可以添加防抖
});
</script>
{% endblock %}